<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Activity Logs - Tirumakudalu Properties</title>
    <link rel="icon" type="image/png" href="/images/TirumakudaluProperties_Logo-2048x1858.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Hide all content by default - only show after authentication check passes */
        body {
            display: none !important;
            visibility: hidden !important;
        }
        body.authenticated {
            display: block !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <!-- Authentication Check - Must run immediately before any content -->
    <script>
        (function() {
            'use strict';
            
            try {
                // Function to clear all authentication data
                function clearAllAuthData() {
                    try {
                        sessionStorage.removeItem('dashboard_authenticated');
                        sessionStorage.removeItem('isAuthenticated');
                        sessionStorage.removeItem('user');
                        localStorage.removeItem('dashboard_authenticated');
                        localStorage.removeItem('isAuthenticated');
                        localStorage.removeItem('user');
                    } catch (e) {
                        // Ignore errors during cleanup
                    }
                }
                
                // CRITICAL FIX: Add retry mechanism for timing issues
                // Sometimes storage isn't immediately available after redirect
                function checkAuthWithRetry(retryCount = 0) {
                    const MAX_RETRIES = 3;
                    const RETRY_DELAY = 50; // 50ms between retries
                    
                    // IMMEDIATE CHECK: Get authentication data synchronously
                    // Prioritize localStorage (persistent) over sessionStorage
                    let localAuth, sessionAuth, localUserStr, sessionUserStr;
                    try {
                        localAuth = localStorage.getItem('dashboard_authenticated');
                        sessionAuth = sessionStorage.getItem('dashboard_authenticated');
                        localUserStr = localStorage.getItem('user');
                        sessionUserStr = sessionStorage.getItem('user');
                    } catch (e) {
                        // Storage access failed - treat as not authenticated
                        console.error('Storage access failed:', e);
                        clearAllAuthData();
                        window.location.replace('/index.html');
                        return false;
                    }
                    
                    // CRITICAL: Sync localStorage to sessionStorage for persistence
                    // If localStorage has auth but sessionStorage doesn't, sync it
                    if (localAuth === 'true' && localUserStr && (!sessionAuth || !sessionUserStr)) {
                        try {
                            sessionStorage.setItem('dashboard_authenticated', 'true');
                            sessionStorage.setItem('user', localUserStr);
                            sessionAuth = 'true';
                            sessionUserStr = localUserStr;
                        } catch (e) {
                            console.error('Error syncing to sessionStorage:', e);
                        }
                    }
                    
                    // Check if authentication flag exists (prioritize localStorage)
                    const isAuthenticated = (localAuth === 'true') || (sessionAuth === 'true');
                    
                    // Get user data (prioritize localStorage)
                    const userStr = localUserStr || sessionUserStr;
                    
                    // Validate user data exists and is valid JSON with required fields
                    let hasValidUser = false;
                    let user = null;
                    
                    if (userStr) {
                        try {
                            user = JSON.parse(userStr);
                            // STRICT VALIDATION: Must have email (non-empty string) AND admin role
                            if (user && 
                                user.email && 
                                typeof user.email === 'string' && 
                                user.email.trim() !== '' && 
                                user.role === 'admin') {
                                hasValidUser = true;
                            } else {
                                // Invalid user data
                                console.warn('Invalid user data:', user);
                                user = null;
                                hasValidUser = false;
                            }
                        } catch (e) {
                            // Invalid JSON
                            console.error('Error parsing user data:', e, 'Raw:', userStr);
                            user = null;
                            hasValidUser = false;
                        }
                    }
                    
                    // CRITICAL CHECK: Both authentication flag AND valid user data must exist
                    // If either is missing or invalid, retry or redirect
                    if (!isAuthenticated || !hasValidUser || !user) {
                        // If we haven't exhausted retries and this looks like a timing issue, retry
                        if (retryCount < MAX_RETRIES) {
                            // Check if we're coming from a login redirect (has _login param)
                            const urlParams = new URLSearchParams(window.location.search);
                            const isLoginRedirect = urlParams.has('_login');
                            
                            if (isLoginRedirect) {
                                // This is a login redirect - storage might not be ready yet
                                console.log(`Auth check failed (attempt ${retryCount + 1}/${MAX_RETRIES}), retrying...`, {
                                    isAuthenticated,
                                    hasValidUser,
                                    hasUserStr: !!userStr,
                                    localAuth,
                                    sessionAuth
                                });
                                setTimeout(() => {
                                    checkAuthWithRetry(retryCount + 1);
                                }, RETRY_DELAY);
                                return false;
                            }
                        }
                        
                        // No retries left or not a login redirect - redirect to login
                        console.error('Authentication check failed after retries:', {
                            isAuthenticated,
                            hasValidUser,
                            hasUser: !!user,
                            localAuth,
                            sessionAuth,
                            retryCount
                        });
                        clearAllAuthData();
                        // Redirect immediately - use replace to prevent back button
                        try {
                            window.location.replace('/index.html');
                        } catch (e) {
                            try {
                                window.location.href = '/index.html';
                            } catch (e2) {
                                // Last resort - show error and redirect
                                if (document.body) {
                                    document.body.style.display = 'block';
                                    document.body.innerHTML = '<div style="font-family: Inter, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center;"><div><h1>Unauthorized Access</h1><p>Redirecting to login...</p></div></div>';
                                    setTimeout(function() {
                                        window.location.href = '/index.html';
                                    }, 1000);
                                }
                            }
                        }
                        return false;
                    }
                    
                    // Authentication passed - sync to sessionStorage if needed
                    if (localAuth === 'true' && localUserStr && (!sessionAuth || !sessionUserStr)) {
                        try {
                            sessionStorage.setItem('dashboard_authenticated', 'true');
                            sessionStorage.setItem('user', localUserStr);
                        } catch (e) {
                            console.error('Error syncing to sessionStorage:', e);
                        }
                    }
                    
                    // Authentication passed - return user data
                    return { user, isAuthenticated, hasValidUser };
                }
                
                // Perform auth check with retry
                const authResult = checkAuthWithRetry();
                if (!authResult) {
                    return; // Redirect already handled
                }
                
                const { user, isAuthenticated, hasValidUser } = authResult;
            
            // Authentication passed - show the page
            document.body.classList.add('authenticated');
        })();
    </script>
    
    <!-- Activity Logs Page (shown when authenticated) -->
    <div class="dashboard-container" id="activityLogsContainer">
        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <div class="dashboard-header-content">
                <div class="dashboard-header-left">
                    <a href="/index.html" class="dashboard-logo-link">
                        <div class="logo-graphic">
                            <img src="/images/TirumakudaluProperties_Logo-2048x1858.png" alt="Tirumakudalu Properties Logo" class="logo-img">
                        </div>
                    </a>
                    <!-- Dashboard Navigation -->
                    <nav class="dashboard-nav">
                        <ul class="dashboard-nav-menu">
                            <li><a href="/index.html">HOME</a></li>
                            <li><a href="/properties.html">PROPERTIES</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="dashboard-header-right">
                    <a href="/dashboard.html" class="dashboard-view-site">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <button class="dashboard-logout" id="activityLogsLogout">
                        <i class="fas fa-sign-out-alt"></i>
                        LOGOUT
                    </button>
                </div>
            </div>
        </header>

        <!-- Activity Logs Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-content">
                <!-- Activity Logs Section -->
                <div class="dashboard-properties-section">
                    <div class="dashboard-section-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <h2>
                                <i class="fas fa-list-alt" style="margin-right: 0.5rem;"></i>
                                Activity Logs
                            </h2>
                            <span id="logsCount" style="color: var(--text-light); font-size: 18px; font-weight: normal;">
                                (Loading...)
                            </span>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <select id="logTypeFilter" class="dashboard-log-filter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 5px; font-size: 22px;">
                                <option value="">All Types</option>
                                <option value="info">Info</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                                <option value="action">Action</option>
                            </select>
                            <div class="dashboard-search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="logSearch" placeholder="Search logs...">
                            </div>
                            <input type="file" id="importLogsFile" accept=".csv" style="display: none;">
                            <button class="dashboard-export dashboard-import" id="importLogsBtn" title="Import Activity Logs from CSV" style="white-space: nowrap;">
                                <i class="fas fa-upload"></i>
                                IMPORT CSV
                            </button>
                            <button class="dashboard-export" id="exportLogsBtn" title="Export Activity Logs to CSV" style="white-space: nowrap;">
                                <i class="fas fa-download"></i>
                                EXPORT CSV
                            </button>
                        </div>
                    </div>
                    <div class="dashboard-properties-table-container logs-table-container">
                        <table class="dashboard-properties-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Action</th>
                                    <th>Description</th>
                                    <th>User</th>
                                    <th>IP Address</th>
                                    <th>Date & Time</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <!-- Logs will be loaded here -->
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                                        Loading logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/session-manager.js"></script>
    <script src="/js/activity-logs.js"></script>
    <script src="/js/page-tracking.js"></script>
</body>
</html>
