<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Settings - Tirumakudalu Properties</title>
    <link rel="icon" type="image/webp" href="/images/TS_logo.webp">
    <link rel="stylesheet" href="/css/style.css">
    <!-- Google Fonts - Load with fallback, no preconnect to avoid connection issues -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet" onerror="this.onerror=null; this.href='';">
    <!-- Font Awesome - Load with fallback -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.onerror=null; this.remove();">
    <style>
        /* Hide all content by default - only show after authentication check passes */
        body {
            display: none !important;
            visibility: hidden !important;
        }
        body.authenticated {
            display: block !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <!-- Authentication Check - Must run immediately before any content -->
    <script>
        (function() {
            'use strict';
            
            try {
                // Function to clear all authentication data
                function clearAllAuthData() {
                    try {
                        sessionStorage.removeItem('dashboard_authenticated');
                        sessionStorage.removeItem('isAuthenticated');
                        sessionStorage.removeItem('user');
                        localStorage.removeItem('dashboard_authenticated');
                        localStorage.removeItem('isAuthenticated');
                        localStorage.removeItem('user');
                    } catch (e) {
                        // Ignore errors during cleanup
                    }
                }
                
                // CRITICAL FIX: Add retry mechanism for timing issues
                // Sometimes storage isn't immediately available after redirect
                function checkAuthWithRetry(retryCount = 0) {
                    const MAX_RETRIES = 3;
                    const RETRY_DELAY = 50; // 50ms between retries
                    
                    // IMMEDIATE CHECK: Get authentication data synchronously
                    // Prioritize localStorage (persistent) over sessionStorage
                    let localAuth, sessionAuth, localUserStr, sessionUserStr;
                    try {
                        localAuth = localStorage.getItem('dashboard_authenticated');
                        sessionAuth = sessionStorage.getItem('dashboard_authenticated');
                        localUserStr = localStorage.getItem('user');
                        sessionUserStr = sessionStorage.getItem('user');
                    } catch (e) {
                        // Storage access failed - treat as not authenticated
                        console.error('Storage access failed:', e);
                        clearAllAuthData();
                        window.location.replace('/index.html');
                        return false;
                    }
                    
                    // CRITICAL: Sync localStorage to sessionStorage for persistence
                    // If localStorage has auth but sessionStorage doesn't, sync it
                    if (localAuth === 'true' && localUserStr && (!sessionAuth || !sessionUserStr)) {
                        try {
                            sessionStorage.setItem('dashboard_authenticated', 'true');
                            sessionStorage.setItem('user', localUserStr);
                            sessionAuth = 'true';
                            sessionUserStr = localUserStr;
                        } catch (e) {
                            console.error('Error syncing to sessionStorage:', e);
                        }
                    }
                    
                    // Check if authentication flag exists (prioritize localStorage)
                    const isAuthenticated = (localAuth === 'true') || (sessionAuth === 'true');
                    
                    // Get user data (prioritize localStorage)
                    const userStr = localUserStr || sessionUserStr;
                    
                    // Validate user data exists and is valid JSON with required fields
                    let hasValidUser = false;
                    let user = null;
                    
                    if (userStr) {
                        try {
                            user = JSON.parse(userStr);
                            // STRICT VALIDATION: Must have email (non-empty string) AND admin role
                            if (user && 
                                user.email && 
                                typeof user.email === 'string' && 
                                user.email.trim() !== '' && 
                                user.role === 'admin') {
                                hasValidUser = true;
                            } else {
                                // Invalid user data
                                console.warn('Invalid user data:', user);
                                user = null;
                                hasValidUser = false;
                            }
                        } catch (e) {
                            // Invalid JSON
                            console.error('Error parsing user data:', e, 'Raw:', userStr);
                            user = null;
                            hasValidUser = false;
                        }
                    }
                    
                    // CRITICAL CHECK: Both authentication flag AND valid user data must exist
                    // If either is missing or invalid, retry or redirect
                    if (!isAuthenticated || !hasValidUser || !user) {
                        // If we haven't exhausted retries and this looks like a timing issue, retry
                        if (retryCount < MAX_RETRIES) {
                            // Check if we're coming from a login redirect (has _login param)
                            const urlParams = new URLSearchParams(window.location.search);
                            const isLoginRedirect = urlParams.has('_login');
                            
                            if (isLoginRedirect) {
                                // This is a login redirect - storage might not be ready yet
                                console.log(`Auth check failed (attempt ${retryCount + 1}/${MAX_RETRIES}), retrying...`, {
                                    isAuthenticated,
                                    hasValidUser,
                                    hasUserStr: !!userStr,
                                    localAuth,
                                    sessionAuth
                                });
                                setTimeout(() => {
                                    checkAuthWithRetry(retryCount + 1);
                                }, RETRY_DELAY);
                                return false;
                            }
                        }
                        
                        // No retries left or not a login redirect - redirect to login
                        console.error('Authentication check failed after retries:', {
                            isAuthenticated,
                            hasValidUser,
                            hasUser: !!user,
                            localAuth,
                            sessionAuth,
                            retryCount
                        });
                        clearAllAuthData();
                        // Redirect immediately - use replace to prevent back button
                        try {
                            window.location.replace('/index.html');
                        } catch (e) {
                            try {
                                window.location.href = '/index.html';
                            } catch (e2) {
                                // Last resort - show error and redirect
                                if (document.body) {
                                    document.body.style.display = 'block';
                                    document.body.innerHTML = '<div style="font-family: Inter, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center;"><div><h1>Unauthorized Access</h1><p>Redirecting to login...</p></div></div>';
                                    setTimeout(function() {
                                        window.location.href = '/index.html';
                                    }, 1000);
                                }
                            }
                        }
                        return false;
                    }
                    
                    // Authentication passed - sync to sessionStorage if needed
                    if (localAuth === 'true' && localUserStr && (!sessionAuth || !sessionUserStr)) {
                        try {
                            sessionStorage.setItem('dashboard_authenticated', 'true');
                            sessionStorage.setItem('user', localUserStr);
                        } catch (e) {
                            console.error('Error syncing to sessionStorage:', e);
                        }
                    }
                    
                    // Authentication passed - return user data
                    return { user, isAuthenticated, hasValidUser };
                }
                
                // Perform auth check with retry
                const authResult = checkAuthWithRetry();
                if (!authResult) {
                    return; // Redirect already handled
                }
                
                const { user, isAuthenticated, hasValidUser } = authResult;
            
                // Authentication passed - show the page
                document.body.classList.add('authenticated');
            } catch (e) {
                console.error('Error during authentication check:', e);
                // Redirect to login on error
                window.location.replace('/index.html');
            }
        })();
    </script>
    
    <!-- Settings Page (shown when authenticated) -->
    <div class="dashboard-container" id="settingsContainer">
        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <div class="dashboard-header-content">
                <div class="dashboard-header-left">
                    <a href="/" class="dashboard-logo-link">
                        <div class="logo-graphic">
                            <img src="/images/TS_logo.webp" alt="Tirumakudalu Properties Logo" class="logo-img" loading="lazy">
                        </div>
                    </a>
                    <!-- Dashboard Navigation -->
                    <nav class="dashboard-nav">
                        <ul class="dashboard-nav-menu">
                            <li><a href="/index.html">HOME</a></li>
                            <li><a href="/properties.html">PROPERTIES</a></li>
                            <li><a href="/dashboard.html">DASHBOARD</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="dashboard-header-right">
                    <!-- User Profile Dropdown -->
                    <div class="dashboard-user-profile" id="dashboardUserProfile">
                        <button class="dashboard-profile-btn" id="dashboardProfileBtn">
                            <div class="dashboard-profile-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="dashboard-profile-name" id="dashboardProfileName">Admin</span>
                            <i class="fas fa-chevron-down dashboard-profile-chevron"></i>
                        </button>
                        <div class="dashboard-profile-dropdown" id="dashboardProfileDropdown">
                            <div class="dashboard-profile-header">
                                <div class="dashboard-profile-avatar-large">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="dashboard-profile-info">
                                    <div class="dashboard-profile-fullname" id="dashboardProfileFullname">Admin User</div>
                                    <div class="dashboard-profile-email" id="dashboardProfileEmail">admin@example.com</div>
                                </div>
                            </div>
                            <div class="dashboard-profile-divider"></div>
                            <a href="/settings.html" class="dashboard-profile-item" target="_blank">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                            <a href="/app-metrics.html" class="dashboard-profile-item" id="appMetricsLink">
                                <i class="fas fa-chart-line"></i>
                                <span>App Metrics</span>
                            </a>
                            <a href="/activity-logs.html" class="dashboard-profile-item" target="_blank">
                                <i class="fas fa-history"></i>
                                <span>Activity Logs</span>
                            </a>
                            <button class="dashboard-profile-item dashboard-profile-logout" id="dashboardLogout">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Settings Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-content">
                <!-- Page Header -->
                <div class="dashboard-welcome">
                    <h1 class="dashboard-welcome-title">
                        <i class="fas fa-cog"></i>
                        Settings
                    </h1>
                    <p class="dashboard-welcome-subtitle">Manage city activation, categories, and unit types</p>
                </div>

                <!-- State Activation Section -->
                <div class="dashboard-properties-section">
                    <div class="dashboard-section-header">
                        <h2>
                            <i class="fas fa-map-marked-alt" style="margin-right: 0.5rem;"></i>
                            State Activation
                        </h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div class="dashboard-search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="stateSearch" placeholder="Search states...">
                            </div>
                            <button class="dashboard-btn-secondary" id="selectAllStatesBtn">
                                <i class="fas fa-check-square"></i>
                                Select All
                            </button>
                            <button class="dashboard-btn-secondary" id="deselectAllStatesBtn">
                                <i class="fas fa-square"></i>
                                Deselect All
                            </button>
                            <button class="dashboard-btn-primary" id="saveStatesBtn">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>
                    <div class="dashboard-properties-table-container" style="max-height: 600px; overflow-y: auto;">
                        <table class="dashboard-properties-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" id="selectAllStatesCheckbox" style="width: auto;">
                                    </th>
                                    <th>State Name</th>
                                    <th>Status</th>
                                    <th>Properties Count</th>
                                </tr>
                            </thead>
                            <tbody id="statesTableBody">
                                <!-- States will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Category Section -->
                <div class="dashboard-properties-section">
                    <div class="dashboard-section-header">
                        <h2>
                            <i class="fas fa-tags" style="margin-right: 0.5rem;"></i>
                            Category Settings
                        </h2>
                        <button class="dashboard-btn-primary" id="addCategoryBtn">
                            <i class="fas fa-plus"></i>
                            Add Category
                        </button>
                    </div>
                    <div class="dashboard-properties-table-container">
                        <table class="dashboard-properties-table">
                            <thead>
                                <tr>
                                    <th>Category Name</th>
                                    <th>Display Name</th>
                                    <th>Status</th>
                                    <th>Properties Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTableBody">
                                <!-- Categories will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Unit Type Section -->
                <div class="dashboard-properties-section">
                    <div class="dashboard-section-header">
                        <h2>
                            <i class="fas fa-home" style="margin-right: 0.5rem;"></i>
                            Unit Type Settings
                        </h2>
                        <button class="dashboard-btn-primary" id="addUnitTypeBtn">
                            <i class="fas fa-plus"></i>
                            Add Unit Type
                        </button>
                    </div>
                    <div class="dashboard-properties-table-container">
                        <table class="dashboard-properties-table">
                            <thead>
                                <tr>
                                    <th>Unit Type</th>
                                    <th>Display Name</th>
                                    <th>Bedrooms</th>
                                    <th>Status</th>
                                    <th>Properties Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="unitTypesTableBody">
                                <!-- Unit types will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notifications will be dynamically created -->

    <!-- Add/Edit Category Modal -->
    <div class="dashboard-modal" id="categoryModal">
        <div class="dashboard-modal-overlay" id="categoryModalOverlay"></div>
        <div class="dashboard-modal-content">
            <div class="dashboard-modal-header">
                <h2 id="categoryModalTitle">Add Category</h2>
                <button class="dashboard-modal-close" id="categoryModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="dashboard-property-form" id="categoryForm">
                <input type="hidden" id="categoryId" name="id">
                <div class="dashboard-form-group">
                    <label for="categoryName">
                        <i class="fas fa-tag"></i>
                        Category Name *
                    </label>
                    <input type="text" id="categoryName" name="name" placeholder="e.g., residential" required>
                </div>
                <div class="dashboard-form-group">
                    <label for="categoryDisplayName">
                        <i class="fas fa-eye"></i>
                        Display Name *
                    </label>
                    <input type="text" id="categoryDisplayName" name="display_name" placeholder="e.g., Residential" required>
                </div>
                <div class="dashboard-modal-actions">
                    <button type="button" class="dashboard-btn-secondary" id="cancelCategoryBtn">Cancel</button>
                    <button type="submit" class="dashboard-btn-primary">
                        <i class="fas fa-save"></i>
                        Save Category
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Unit Type Modal -->
    <div class="dashboard-modal" id="unitTypeModal">
        <div class="dashboard-modal-overlay" id="unitTypeModalOverlay"></div>
        <div class="dashboard-modal-content">
            <div class="dashboard-modal-header">
                <h2 id="unitTypeModalTitle">Add Unit Type</h2>
                <button class="dashboard-modal-close" id="unitTypeModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="dashboard-property-form" id="unitTypeForm">
                <input type="hidden" id="unitTypeId" name="id">
                <div class="dashboard-form-group">
                    <label for="unitTypeName">
                        <i class="fas fa-home"></i>
                        Unit Type *
                    </label>
                    <input type="text" id="unitTypeName" name="name" placeholder="e.g., 1BHK" required>
                </div>
                <div class="dashboard-form-group">
                    <label for="unitTypeDisplayName">
                        <i class="fas fa-eye"></i>
                        Display Name *
                    </label>
                    <input type="text" id="unitTypeDisplayName" name="display_name" placeholder="e.g., 1 BHK" required>
                </div>
                <div class="dashboard-modal-actions">
                    <button type="button" class="dashboard-btn-secondary" id="cancelUnitTypeBtn">Cancel</button>
                    <button type="submit" class="dashboard-btn-primary">
                        <i class="fas fa-save"></i>
                        Save Unit Type
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Suppress browser extension errors that are not related to our code
        window.addEventListener('error', function(event) {
            // Suppress common browser extension errors
            if (event.message && (
                event.message.includes('message channel closed') ||
                event.message.includes('Extension context invalidated') ||
                event.message.includes('Receiving end does not exist') ||
                event.message.includes('asynchronous response') ||
                event.message.includes('message channel closed before a response')
            )) {
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
        }, true);
        
        // Suppress unhandled promise rejections from browser extensions
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && typeof event.reason === 'object' && event.reason.message) {
                const message = event.reason.message;
                if (message.includes('message channel closed') ||
                    message.includes('Extension context invalidated') ||
                    message.includes('Receiving end does not exist') ||
                    message.includes('asynchronous response') ||
                    message.includes('message channel closed before a response')) {
                    event.preventDefault();
                    return false;
                }
            }
            // Also check string errors
            if (typeof event.reason === 'string' && (
                event.reason.includes('message channel closed') ||
                event.reason.includes('Extension context invalidated') ||
                event.reason.includes('asynchronous response') ||
                event.reason.includes('message channel closed before a response')
            )) {
                event.preventDefault();
                return false;
            }
        });
    </script>
    <!-- 1ï¸âƒ£ Data first -->
    <script src="/js/cityData.js"></script>

    <!-- 2ï¸âƒ£ Session manager -->
    <script src="/js/session-manager.js" defer></script>

    <!-- 3ï¸âƒ£ Settings logic -->
    <script src="/js/settings.js"></script>
    <script>
        // App Metrics Password Protection
        document.addEventListener('DOMContentLoaded', function() {
            const appMetricsLink = document.getElementById('appMetricsLink');
            if (appMetricsLink) {
                appMetricsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const password = prompt('Enter password to access App Metrics:');
                    if (!password) {
                        return;
                    }
                    
                    fetch('/api/admin/verify-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password: password })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success === true) {
                            // Store verification in sessionStorage
                            sessionStorage.setItem('app_metrics_verified', 'true');
                            console.log('Password verified, redirecting to app-metrics...');
                            // Use replace instead of href to prevent back button issues
                            window.location.replace('/app-metrics.html');
                        } else {
                            console.error('Password verification failed:', data.message);
                            alert(data.message || 'Invalid password');
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying password:', error);
                        alert('Error verifying password: ' + (error.message || 'Please try again.'));
                    });
                });
            }
        });
    </script>
</body>
</html>
